/*
 * QUICKEN UI Draw Primitives
 *
 * Implements qk_ui_draw_* functions declared in renderer/qk_renderer.h.
 * These bridge the UI module and the renderer by converting high-level
 * draw calls into qk_ui_quad_t pushes.
 *
 * Includes a procedurally-generated 8x8 bitmap font atlas covering
 * ASCII printable range (32-126). The atlas is uploaded on first use.
 */

#include "renderer/qk_renderer.h"
#include <string.h>
#include <stdio.h>

// --- Bitmap Font Atlas ---

/*
 * 8x8 pixel monospace font, covering ASCII 32..126 (95 glyphs).
 * Each glyph is 8 bytes, each byte is one row (MSB = leftmost pixel).
 *
 * Atlas layout: 16 columns x 6 rows = 96 cells (128x48 pixels)
 * Glyph index = ascii - 32, cell_x = index % 16, cell_y = index / 16
 */
#define FONT_GLYPH_W       8
#define FONT_GLYPH_H       8
#define FONT_ATLAS_COLS     16
#define FONT_ATLAS_ROWS     6
#define FONT_ATLAS_W        (FONT_GLYPH_W * FONT_ATLAS_COLS)   // 128
#define FONT_ATLAS_H        (FONT_GLYPH_H * FONT_ATLAS_ROWS)   // 48
#define FONT_FIRST_CHAR     32
#define FONT_LAST_CHAR      126
#define FONT_GLYPH_COUNT    (FONT_LAST_CHAR - FONT_FIRST_CHAR + 1) // 95

// 8x8 pixel data for each glyph (8 bytes per glyph, MSB=left)
static const u8 s_font_glyphs[FONT_GLYPH_COUNT][8] = {
    /* 32 ' ' */ { 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00 },
    /* 33 '!' */ { 0x18,0x18,0x18,0x18,0x18,0x00,0x18,0x00 },
    /* 34 '"' */ { 0x6C,0x6C,0x24,0x00,0x00,0x00,0x00,0x00 },
    /* 35 '#' */ { 0x24,0x7E,0x24,0x24,0x7E,0x24,0x00,0x00 },
    /* 36 '$' */ { 0x18,0x3E,0x58,0x3C,0x1A,0x7C,0x18,0x00 },
    /* 37 '%' */ { 0x62,0x64,0x08,0x10,0x26,0x46,0x00,0x00 },
    /* 38 '&' */ { 0x30,0x48,0x30,0x56,0x88,0x76,0x00,0x00 },
    /* 39 ''' */ { 0x18,0x18,0x10,0x00,0x00,0x00,0x00,0x00 },
    /* 40 '(' */ { 0x0C,0x18,0x30,0x30,0x30,0x18,0x0C,0x00 },
    /* 41 ')' */ { 0x30,0x18,0x0C,0x0C,0x0C,0x18,0x30,0x00 },
    /* 42 '*' */ { 0x00,0x24,0x18,0x7E,0x18,0x24,0x00,0x00 },
    /* 43 '+' */ { 0x00,0x18,0x18,0x7E,0x18,0x18,0x00,0x00 },
    /* 44 ',' */ { 0x00,0x00,0x00,0x00,0x00,0x18,0x18,0x10 },
    /* 45 '-' */ { 0x00,0x00,0x00,0x7E,0x00,0x00,0x00,0x00 },
    /* 46 '.' */ { 0x00,0x00,0x00,0x00,0x00,0x18,0x18,0x00 },
    /* 47 '/' */ { 0x02,0x04,0x08,0x10,0x20,0x40,0x00,0x00 },
    /* 48 '0' */ { 0x3C,0x46,0x4A,0x52,0x62,0x3C,0x00,0x00 },
    /* 49 '1' */ { 0x18,0x38,0x18,0x18,0x18,0x7E,0x00,0x00 },
    /* 50 '2' */ { 0x3C,0x42,0x02,0x1C,0x20,0x7E,0x00,0x00 },
    /* 51 '3' */ { 0x3C,0x42,0x0C,0x02,0x42,0x3C,0x00,0x00 },
    /* 52 '4' */ { 0x0C,0x14,0x24,0x44,0x7E,0x04,0x00,0x00 },
    /* 53 '5' */ { 0x7E,0x40,0x7C,0x02,0x42,0x3C,0x00,0x00 },
    /* 54 '6' */ { 0x1C,0x20,0x7C,0x42,0x42,0x3C,0x00,0x00 },
    /* 55 '7' */ { 0x7E,0x02,0x04,0x08,0x10,0x10,0x00,0x00 },
    /* 56 '8' */ { 0x3C,0x42,0x3C,0x42,0x42,0x3C,0x00,0x00 },
    /* 57 '9' */ { 0x3C,0x42,0x42,0x3E,0x04,0x38,0x00,0x00 },
    /* 58 ':' */ { 0x00,0x00,0x18,0x00,0x00,0x18,0x00,0x00 },
    /* 59 ';' */ { 0x00,0x00,0x18,0x00,0x00,0x18,0x18,0x10 },
    /* 60 '<' */ { 0x04,0x08,0x10,0x20,0x10,0x08,0x04,0x00 },
    /* 61 '=' */ { 0x00,0x00,0x7E,0x00,0x7E,0x00,0x00,0x00 },
    /* 62 '>' */ { 0x20,0x10,0x08,0x04,0x08,0x10,0x20,0x00 },
    /* 63 '?' */ { 0x3C,0x42,0x04,0x08,0x08,0x00,0x08,0x00 },
    /* 64 '@' */ { 0x3C,0x42,0x4E,0x52,0x4C,0x40,0x3C,0x00 },
    /* 65 'A' */ { 0x18,0x24,0x42,0x7E,0x42,0x42,0x00,0x00 },
    /* 66 'B' */ { 0x7C,0x42,0x7C,0x42,0x42,0x7C,0x00,0x00 },
    /* 67 'C' */ { 0x3C,0x42,0x40,0x40,0x42,0x3C,0x00,0x00 },
    /* 68 'D' */ { 0x78,0x44,0x42,0x42,0x44,0x78,0x00,0x00 },
    /* 69 'E' */ { 0x7E,0x40,0x7C,0x40,0x40,0x7E,0x00,0x00 },
    /* 70 'F' */ { 0x7E,0x40,0x7C,0x40,0x40,0x40,0x00,0x00 },
    /* 71 'G' */ { 0x3C,0x42,0x40,0x4E,0x42,0x3C,0x00,0x00 },
    /* 72 'H' */ { 0x42,0x42,0x7E,0x42,0x42,0x42,0x00,0x00 },
    /* 73 'I' */ { 0x7E,0x18,0x18,0x18,0x18,0x7E,0x00,0x00 },
    /* 74 'J' */ { 0x1E,0x04,0x04,0x04,0x44,0x38,0x00,0x00 },
    /* 75 'K' */ { 0x44,0x48,0x70,0x48,0x44,0x42,0x00,0x00 },
    /* 76 'L' */ { 0x40,0x40,0x40,0x40,0x40,0x7E,0x00,0x00 },
    /* 77 'M' */ { 0x42,0x66,0x5A,0x42,0x42,0x42,0x00,0x00 },
    /* 78 'N' */ { 0x42,0x62,0x52,0x4A,0x46,0x42,0x00,0x00 },
    /* 79 'O' */ { 0x3C,0x42,0x42,0x42,0x42,0x3C,0x00,0x00 },
    /* 80 'P' */ { 0x7C,0x42,0x42,0x7C,0x40,0x40,0x00,0x00 },
    /* 81 'Q' */ { 0x3C,0x42,0x42,0x4A,0x44,0x3A,0x00,0x00 },
    /* 82 'R' */ { 0x7C,0x42,0x42,0x7C,0x44,0x42,0x00,0x00 },
    /* 83 'S' */ { 0x3C,0x40,0x3C,0x02,0x42,0x3C,0x00,0x00 },
    /* 84 'T' */ { 0x7E,0x18,0x18,0x18,0x18,0x18,0x00,0x00 },
    /* 85 'U' */ { 0x42,0x42,0x42,0x42,0x42,0x3C,0x00,0x00 },
    /* 86 'V' */ { 0x42,0x42,0x42,0x24,0x24,0x18,0x00,0x00 },
    /* 87 'W' */ { 0x42,0x42,0x42,0x5A,0x66,0x42,0x00,0x00 },
    /* 88 'X' */ { 0x42,0x24,0x18,0x18,0x24,0x42,0x00,0x00 },
    /* 89 'Y' */ { 0x42,0x24,0x18,0x18,0x18,0x18,0x00,0x00 },
    /* 90 'Z' */ { 0x7E,0x04,0x08,0x10,0x20,0x7E,0x00,0x00 },
    /* 91 '[' */ { 0x3C,0x30,0x30,0x30,0x30,0x3C,0x00,0x00 },
    /* 92 '\' */ { 0x40,0x20,0x10,0x08,0x04,0x02,0x00,0x00 },
    /* 93 ']' */ { 0x3C,0x0C,0x0C,0x0C,0x0C,0x3C,0x00,0x00 },
    /* 94 '^' */ { 0x10,0x28,0x44,0x00,0x00,0x00,0x00,0x00 },
    /* 95 '_' */ { 0x00,0x00,0x00,0x00,0x00,0x00,0x7E,0x00 },
    /* 96 '`' */ { 0x18,0x18,0x08,0x00,0x00,0x00,0x00,0x00 },
    /* 97 'a' */ { 0x00,0x00,0x3C,0x02,0x3E,0x42,0x3E,0x00 },
    /* 98 'b' */ { 0x40,0x40,0x7C,0x42,0x42,0x42,0x7C,0x00 },
    /* 99 'c' */ { 0x00,0x00,0x3C,0x40,0x40,0x40,0x3C,0x00 },
    /*100 'd' */ { 0x02,0x02,0x3E,0x42,0x42,0x42,0x3E,0x00 },
    /*101 'e' */ { 0x00,0x00,0x3C,0x42,0x7E,0x40,0x3C,0x00 },
    /*102 'f' */ { 0x0C,0x10,0x3C,0x10,0x10,0x10,0x10,0x00 },
    /*103 'g' */ { 0x00,0x00,0x3E,0x42,0x42,0x3E,0x02,0x3C },
    /*104 'h' */ { 0x40,0x40,0x7C,0x42,0x42,0x42,0x42,0x00 },
    /*105 'i' */ { 0x18,0x00,0x38,0x18,0x18,0x18,0x3C,0x00 },
    /*106 'j' */ { 0x04,0x00,0x04,0x04,0x04,0x04,0x44,0x38 },
    /*107 'k' */ { 0x40,0x40,0x44,0x48,0x70,0x48,0x44,0x00 },
    /*108 'l' */ { 0x38,0x18,0x18,0x18,0x18,0x18,0x3C,0x00 },
    /*109 'm' */ { 0x00,0x00,0x76,0x49,0x49,0x49,0x49,0x00 },
    /*110 'n' */ { 0x00,0x00,0x7C,0x42,0x42,0x42,0x42,0x00 },
    /*111 'o' */ { 0x00,0x00,0x3C,0x42,0x42,0x42,0x3C,0x00 },
    /*112 'p' */ { 0x00,0x00,0x7C,0x42,0x42,0x7C,0x40,0x40 },
    /*113 'q' */ { 0x00,0x00,0x3E,0x42,0x42,0x3E,0x02,0x02 },
    /*114 'r' */ { 0x00,0x00,0x5C,0x60,0x40,0x40,0x40,0x00 },
    /*115 's' */ { 0x00,0x00,0x3E,0x40,0x3C,0x02,0x7C,0x00 },
    /*116 't' */ { 0x10,0x10,0x3C,0x10,0x10,0x10,0x0C,0x00 },
    /*117 'u' */ { 0x00,0x00,0x42,0x42,0x42,0x42,0x3E,0x00 },
    /*118 'v' */ { 0x00,0x00,0x42,0x42,0x24,0x24,0x18,0x00 },
    /*119 'w' */ { 0x00,0x00,0x42,0x42,0x5A,0x66,0x42,0x00 },
    /*120 'x' */ { 0x00,0x00,0x42,0x24,0x18,0x24,0x42,0x00 },
    /*121 'y' */ { 0x00,0x00,0x42,0x42,0x42,0x3E,0x02,0x3C },
    /*122 'z' */ { 0x00,0x00,0x7E,0x04,0x18,0x20,0x7E,0x00 },
    /*123 '{' */ { 0x0E,0x18,0x18,0x30,0x18,0x18,0x0E,0x00 },
    /*124 '|' */ { 0x18,0x18,0x18,0x18,0x18,0x18,0x18,0x00 },
    /*125 '}' */ { 0x70,0x18,0x18,0x0C,0x18,0x18,0x70,0x00 },
    /*126 '~' */ { 0x00,0x00,0x32,0x4C,0x00,0x00,0x00,0x00 },
};

static u32 s_font_texture_id = 0;
static bool s_font_initialized = false;

static void ui_font_init(void) {
    if (s_font_initialized) return;

    // Rasterize the glyph data into an RGBA pixel buffer
    u8 pixels[FONT_ATLAS_W * FONT_ATLAS_H * 4];
    memset(pixels, 0, sizeof(pixels));

    for (u32 g = 0; g < FONT_GLYPH_COUNT; g++) {
        u32 col = g % FONT_ATLAS_COLS;
        u32 row = g / FONT_ATLAS_COLS;
        u32 base_x = col * FONT_GLYPH_W;
        u32 base_y = row * FONT_GLYPH_H;

        for (u32 y = 0; y < FONT_GLYPH_H; y++) {
            u8 bits = s_font_glyphs[g][y];
            for (u32 x = 0; x < FONT_GLYPH_W; x++) {
                if (bits & (0x80 >> x)) {
                    u32 px = base_x + x;
                    u32 py = base_y + y;
                    u32 idx = (py * FONT_ATLAS_W + px) * 4;
                    pixels[idx + 0] = 255;  // R
                    pixels[idx + 1] = 255;  // G
                    pixels[idx + 2] = 255;  // B
                    pixels[idx + 3] = 255;  // A
                }
            }
        }
    }

    s_font_texture_id = qk_renderer_upload_texture(pixels, FONT_ATLAS_W, FONT_ATLAS_H, 4, true);
    s_font_initialized = true;
}

// --- Solid Rectangle ---
void qk_ui_draw_rect(f32 x, f32 y, f32 w, f32 h, u32 color_rgba) {
    qk_ui_quad_t quad = {
        .x = x, .y = y, .w = w, .h = h,
        .u0 = 0.0f, .v0 = 0.0f, .u1 = 1.0f, .v1 = 1.0f,
        .color = color_rgba,
        .texture_id = 0, // 0 = white/solid fill
    };
    qk_renderer_push_ui_quad(&quad);
}

// --- Text ---
void qk_ui_draw_text(f32 x, f32 y, const char *text, f32 size, u32 color_rgba) {
    if (!text || !text[0]) return;

    ui_font_init();

    f32 scale = size / (f32)FONT_GLYPH_H;
    f32 glyph_w = (f32)FONT_GLYPH_W * scale;
    f32 glyph_h = (f32)FONT_GLYPH_H * scale;
    f32 cx = x;

    f32 inv_atlas_w = 1.0f / (f32)FONT_ATLAS_W;
    f32 inv_atlas_h = 1.0f / (f32)FONT_ATLAS_H;

    for (const char *p = text; *p; p++) {
        u8 ch = (u8)*p;

        if (ch == ' ') {
            cx += glyph_w;
            continue;
        }

        if (ch < FONT_FIRST_CHAR || ch > FONT_LAST_CHAR) {
            cx += glyph_w;
            continue;
        }

        u32 idx = ch - FONT_FIRST_CHAR;
        u32 col = idx % FONT_ATLAS_COLS;
        u32 row = idx / FONT_ATLAS_COLS;

        f32 u0 = (f32)(col * FONT_GLYPH_W) * inv_atlas_w;
        f32 v0 = (f32)(row * FONT_GLYPH_H) * inv_atlas_h;
        f32 u1 = u0 + (f32)FONT_GLYPH_W * inv_atlas_w;
        f32 v1 = v0 + (f32)FONT_GLYPH_H * inv_atlas_h;

        qk_ui_quad_t quad = {
            .x = cx, .y = y, .w = glyph_w, .h = glyph_h,
            .u0 = u0, .v0 = v0, .u1 = u1, .v1 = v1,
            .color = color_rgba,
            .texture_id = s_font_texture_id,
        };
        qk_renderer_push_ui_quad(&quad);

        cx += glyph_w;
    }
}

// --- Number ---
void qk_ui_draw_number(f32 x, f32 y, i32 value, f32 size, u32 color_rgba) {
    char buf[16];
    snprintf(buf, sizeof(buf), "%d", value);
    qk_ui_draw_text(x, y, buf, size, color_rgba);
}

// --- Text Width Measurement ---
f32 qk_ui_text_width(const char *text, f32 size) {
    if (!text) return 0.0f;
    f32 scale = size / (f32)FONT_GLYPH_H;
    f32 glyph_w = (f32)FONT_GLYPH_W * scale;
    f32 width = 0.0f;
    for (const char *p = text; *p; p++) {
        width += glyph_w;
    }
    return width;
}
